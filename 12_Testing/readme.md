# Тестирование бэкенд-приложений

## Предисловие: История, которая вас заставит писать тесты

Представьте ситуацию: вы разработали приложение для заказа еды. Функционирует отлично, вы развернули его на production, пользователи начали создавать заказы. Всё работает идеально — пока...

Однажды разработчик James решил оптимизировать код. Он изменил функцию расчёта стоимости доставки. Тестировал локально — вроде всё работает. Развернул на production.

Через час поступают жалобы:

- Клиент заказал еду на сумму 500 рублей, система взяла 50 рублей
- Клиент вместо доставки за 150 рублей заплатил 1500 рублей
- Клиент не получил свой заказ, потому что система отклонила платёж

За два часа компания потеряла десятки тысяч рублей, репутацию пошатнулась, а то и судебные иски пошли. Если бы было 50 тестов, покрывающих функцию расчёта, Василий узнал бы о проблеме ДО развёртывания.

Именно поэтому тестирование — это неотъемлемая часть разработки. Оно помогает выявить ошибки до того, как они попадут к пользователям, экономит время и ресурсы, а также поддерживает качество кода на высоком уровне.

## Введение в тестирование

### Что такое тестирование бэкенд приложений?

_Тестирование бэкенд приложений_ - это процесс проверки корректности работы серверной части приложения без прямого взаимодействия с пользовательским интерфейсом. Это означает, что мы проверяем функциональность API-эндпоинтов, обработку данных, взаимодействие с базами данных и логику обработки запросов.

Представьте ресторан: если фронтенд — это то, что видит клиент (меню, интерфейс), то бэкенд — это кухня. Тестирование бэкенда гарантирует, что рецепты готовятся правильно, ингредиенты свежие, и блюдо будет готово вовремя, даже если никто его не видит.

### Зачем нужно тестирование?

Рассмотрим реальные цифры и последствия из-за отсутствия тестирования:

- _$4.7 млрд_. Столько потеряла компания Amazon из-за одного часа простоя в 2013 году. Причина — ошибка в коде, которую могли бы поймать тесты.
- _8 месяцев работы_. Столько времени потребовалось на исправление «маленькой» ошибки в системе расчётов банка, которая привела к переводу миллионов по ошибочным счётам.
- _100x стоимость_. Исправление бага, обнаруженного на production, стоит в 100 раз дороже, чем если бы его нашли на этапе разработки.

Тестирование решает множество задач:

- _Раннее обнаружение ошибок_. Баги, обнаруженные на ранних стадиях разработки, стоят намного дешевле, чем исправление их в production после жалоб пользователей.
- _Уверенность в коде_. Когда у вас есть набор тестов, вы можете безопасно рефакторить код, зная, что тесты поймают любые регрессии.
- _Документация функциональности_. Тесты служат живой документацией — они показывают, как должен работать код.
- _Снижение затрат на отладку_. Вместо ручного тестирования каждого сценария, тесты автоматически проверяют сотни комбинаций за несколько минут.
- _Повышение качества кода_. Тестируемый код обычно имеет лучшую архитектуру и слабую связанность.
- _Скорость разработки_. Противоречиво звучит, но команда с хорошим покрытием тестами работает быстрее, потому что тратит меньше времени на отладку и исправление багов.

## Виды тестирования

### Юнит тестирование (Unit Testing)

_Юнит тестирование_ — это тестирование отдельных функций или методов в изоляции от остальной системы. Это наиболее простой и быстрый вид тестирования.

_Характеристики_:

- Тестируется одна функция или метод
- Все зависимости подменяются (мокируются)
- Тесты выполняются очень быстро
- Легко отследить причину ошибки

_Пример. Тестирование функции, которая вычисляет сумму двух чисел_

```js
// src/math.js
function sum(a, b) {
  return a + b;
}

export default sum;
```

```js
// tests/math.test.js
import sum from '../src/math';

// describe, it - функции для организации тестов
// describe - группа тестов
// it - отдельный тест
// данные функции будут рассмотрены позже
describe('sum function', () => {
  it('should add two positive numbers correctly', () => {
    expect(sum(2, 3)).toBe(5);
  });

  it('should add negative numbers correctly', () => {
    expect(sum(-2, -3)).toBe(-5);
  });

  it('should handle zero', () => {
    expect(sum(0, 5)).toBe(5);
  });
});
```

### Интеграционное тестирование (Integration Testing)

_Интеграционное тестирование_ проверяет взаимодействие между несколькими компонентами системы. Это более сложно чем юнит тестирование, но ближе к реальности.

_Характеристики_:

- Тестируется взаимодействие нескольких модулей
- Может использоваться реальная база данных или её in-memory версия, _но никогда не используется production база-данных_
- Тесты выполняются медленнее, чем юнит тесты
- Проверяет, что компоненты работают вместе правильно

_Пример: Тестирование создания задачи в ToDo приложении_

```js
// src/controllers/todoController.js
import TodoModel from '../models/todoModel';

async function createTodo(req, res) {
  try {
    const { title, description } = req.body;
    const todo = await TodoModel.create({ title, description });
    res.status(201).json(todo);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
}

export default createTodo;
```

```js
// src/models/todoModel.js
import pool from '../db/pool';

async function create(todoData) {
  const { title, description } = todoData;
  const result = await pool.query(
    'INSERT INTO todos (title, description) VALUES ($1, $2) RETURNING *',
    [title, description],
  );
  return result.rows[0];
}

export default { create };
```

```js
// tests/todoController.integration.test.js
import request from 'supertest';
import app from '../src/app'; // Express приложение
import TodoModel from '../src/models/todoModel';

describe('Todo Controller Integration Tests', () => {
  beforeEach(async () => {
    // Очищаем БД перед каждым тестом
    await TodoModel.deleteMany({});
  });

  it('should create a new todo', async () => {
    // Выполняем HTTP запрос к нашему API
    const response = await request(app)
      .post('/todos')
      .send({
        title: 'Learn testing',
        description: 'Master Jest and Supertest',
      })
      .expect(201);

    expect(response.body.title).toBe('Learn testing');
    expect(response.body.id).toBeDefined();

    // Проверяем, что todo действительно сохранён в БД
    const savedTodo = await TodoModel.findById(response.body.id);
    expect(savedTodo).toBeDefined();
  });
});
```