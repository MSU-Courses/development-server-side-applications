# Лабораторная работа №2. Работа с базой данных

> Для выполнения данной работы можно продолжить использовать проект из ЛР №1.

## Цель работы

1. Научиться проектировать и реализовывать REST API с несколькими связанными сущностями.
2. Освоить работу с PostgreSQL в приложении на Node.js + Express с использованием ORM или сырых SQL-запросов.
3. Реализовать корректные операции CRUD, а также фильтрацию, сортировку и пагинацию.
4. Освоить принципы работы связей «один ко многим» (1:N) в реляционных базах данных.

## Условие

Разработать сервис для управления задачами (todo list) с возможностью:

- Просмотра списка задач.
- Создания новой задачи.
- Переключения статуса задачи (выполнена/не выполнена).
- Удаления задачи.
- Редактирования задачи.
- Фильтрации задач по категориям.
- Поиска задач по заголовку.
- Пагинации списка задач.

В проекте должны быть реализованы две сущности:

- `categories` — категории задач,
- `todos` — сами задачи, каждая из которых относится к одной категории.

Сервис должен работать только как REST API, без HTML и шаблонов.

> Все ответы и ошибки возвращаются в формате JSON.

### Шаг 1. Создание базы данных

Используя миграции, создайте две таблицы:

- Таблица `todos` для хранения задач.
- Таблица `categories` для хранения категорий задач.

#### Таблица `categories`

| Поле         | Тип          | Описание                           |
| ------------ | ------------ | ---------------------------------- |
| `id`         | SERIAL (PK)  | Уникальный идентификатор категории |
| `name`       | VARCHAR(100) | Название категории                 |
| `created_at` | TIMESTAMP    | Дата создания                      |
| `updated_at` | TIMESTAMP    | Дата обновления                    |

#### Таблица `todos`

| Поле          | Тип       | Описание                                 |
| ------------- | --------- | ---------------------------------------- |
| `id`          | UUID (PK) | Уникальный идентификатор задачи          |
| `title`       | TEXT      | Название задачи (2–120 символов)         |
| `completed`   | BOOLEAN   | Статус выполнения (по умолчанию `false`) |
| `category_id` | INT       | Внешний ключ на категорию (опционально)  |
| `due_date`    | TIMESTAMP | Срок выполнения задачи (опционально)     |
| `created_at`  | TIMESTAMP | Дата создания                            |
| `updated_at`  | TIMESTAMP | Дата последнего обновления               |

### Шаг 2. Создание моделей

Создайте модели для работы со следующими сущностями:

- `Todo`
- `Category`

* Разрешается использовать ORM (Например, `Sequelize`, `Prisma`).

Реализуйте валидацию данных на уровне моделей (например, длина заголовка задачи должна быть от 2 до 120 символов).

### Шаг 3. Реализация API

Реализуйте RESTful API для работы с задачами и категориями.

API должен поддерживать следующие операции:

#### Для категорий

| Метод    | URL                   | Описание                       | Код       |
| -------- | --------------------- | ------------------------------ | --------- |
| `GET`    | `/api/categories`     | Получить список всех категорий | 200       |
| `GET`    | `/api/categories/:id` | Получить категорию по ID       | 200 / 404 |
| `POST`   | `/api/categories`     | Создать категорию (`name`)     | 201       |
| `PUT`    | `/api/categories/:id` | Изменить название категории    | 200 / 404 |
| `DELETE` | `/api/categories/:id` | Удалить категорию              | 204 / 404 |

#### Для задач

| Метод    | URL                     | Описание                                              | Код       |
| -------- | ----------------------- | ----------------------------------------------------- | --------- |
| `GET`    | `/api/todos`            | Список задач (с фильтрацией, поиском и пагинацией)    | 200       |
| `GET`    | `/api/todos/:id`        | Получить задачу по ID                                 | 200 / 404 |
| `POST`   | `/api/todos`            | Создать задачу (`title`, `category_id`)               | 201       |
| `PUT`    | `/api/todos/:id`        | Изменить задачу (`title`, `completed`, `category_id`) | 200 / 404 |
| `PATCH`  | `/api/todos/:id/toggle` | Переключить статус `completed`                        | 200 / 404 |
| `DELETE` | `/api/todos/:id`        | Удалить задачу                                        | 204 / 404 |

- _Примечание_: При запросе GET `/api/todos` каждая задача должна включать поле `category` с информацией о категории.

  ```json
  {
    "id": 0,
    "title": "Купить молоко",
    "completed": false,
    "due_date": "2024-12-31T23:59:59.000Z",
    "created_at": "2024-01-01T12:00:00.000Z",
    "updated_at": "2024-01-01T12:00:00.000Z",
    "category": { "id": 3, "name": "Покупки" }
  }
  ```

### Шаг 4. Дополнительные задания. Фильтрация, поиск и пагинация

> Данные задания не являются обязательными, но позволит углубить понимание материала.

1. Реализуйте фильтрацию по категории:
   1. Например, `GET /api/todos?category=3` — задачи только из категории с id = 3.
2. Реализуйте поиск _по заголовку_ и сортировку:
   1. `?search=<строка>` — поиск по названию задачи.
   2. `?sort=createdAt:desc|asc` или `?sort=title:asc|desc`.
3. Реализуйте пагинацию:

   1. `?page=<номер_страницы>&limit=<количество_на_странице>`.
   2. По умолчанию `page=1`, `limit=10`.

   Ответ API должен содержать структуру:

   ```json
   {
     "data": [
       /* массив задач */
     ],
     "meta": {
       "total": 100,
       "count": 10,
       "limit": 10,
       "pages": 10,
       "currentPage": 1
     }
   }
   ```

4. Для документации API используйте Swagger.

## Контрольные вопросы

1. Что такое реляционная база данных и какие преимущества она предоставляет?
2. Какие типы связей между таблицами существуют в реляционных базах данных?
3. Что такое RESTful API и для чего он используется?
4. Что такое SQL-инъекция и как защититься от неё?
5. В чем разница между ORM и сырыми SQL-запросами? Какие преимущества и недостатки у каждого подхода?
