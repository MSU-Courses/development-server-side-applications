# Лабораторная работа №3. Аутентификация и авторизация

> Для выполнения данной работы можно продолжить использовать проект из ЛР №2.

## Цель работы

1. Освоить методы аутентификации и авторизации в backend-приложениях на Node.js.
2. Реализовать защиту REST API с помощью JWT (JSON Web Token).
3. Научиться разграничивать доступ к ресурсам в зависимости от роли пользователя.

## Условие

Модифицировать существующий сервис ToDo REST API, добавив систему пользователей и механизм JWT-аутентификации.

Сервис должен поддерживать:

- регистрацию и вход пользователей;
- получение JWT-токена при успешном входе;
- использование токена для доступа к защищённым ресурсам (`/api/todos`, `/api/categories`);
- разграничение прав пользователей (администратор может управлять всеми, обычный — только своими).

### Шаг 1. Структура базы данных

Добавьте новую таблицу `users`, а также связь с таблицей `todos`.

Таблица `users`

| Поле         | Тип          | Описание                              |
| ------------ | ------------ | ------------------------------------- |
| `id`         | SERIAL (PK)  | Уникальный идентификатор пользователя |
| `username`   | VARCHAR(50)  | Уникальное имя пользователя           |
| `email`      | VARCHAR(100) | Email пользователя (уникальный)       |
| `password`   | TEXT         | Хэш пароля                            |
| `role`       | VARCHAR(20)  | Роль пользователя (`user`, `admin`)   |
| `created_at` | TIMESTAMP    | Дата регистрации                      |
| `updated_at` | TIMESTAMP    | Дата обновления                       |

Изменения в таблице `todos`, добавьте поле `user_id` для связи с пользователем-владельцем задачи:

| Поле      | Тип          | Описание                                          |
| --------- | ------------ | ------------------------------------------------- |
| `user_id` | INTEGER (FK) | Внешний ключ на таблицу `users` (владелец задачи) |

### Шаг 2. Реализация аутентификации (Authentication)

1. Добавьте маршруты `/api/auth`

   | Метод  | URL                  | Описание                                               | Ответ         |
   | ------ | -------------------- | ------------------------------------------------------ | ------------- |
   | `POST` | `/api/auth/register` | Регистрация нового пользователя                        | `201 Created` |
   | `POST` | `/api/auth/login`    | Вход пользователя (получение JWT)                      | `200 OK`      |
   | `GET`  | `/api/auth/profile`  | Получить информацию о текущем пользователе (по токену) | `200 OK`      |

2. Регистрация (`POST /register`):
   1. Проверьте, что имя пользователя и email уникальны.
   2. Захэшируйте пароль с помощью `bcrypt`.
   3. Создайте пользователя в таблице `users`.
3. Вход (`POST /login`):
   1. Проверьте наличие пользователя и правильность пароля.
   2. Сгенерируйте JWT-токен, содержащий: `userId`, `username`, `role`.
   3. Возвратите токен в ответе.
4. Проверка токена (`GET /profile`):
   1. Токен передаётся в заголовке `Authorization: Bearer <token>`.
   2. Если токен валиден — верните информацию о пользователе.
   3. Если нет — статус `401 Unauthorized`.

### Шаг 3. Реализация авторизации (Authorization)

1. Реализуйте middleware, проверяющее JWT (`auth.middleware.js`)
   1. Если токен отсутствует или невалиден → `401 Unauthorized`.
   2. Если токен валиден → запишите объект пользователя в `req.user`.
2. Реализуйте ролевую авторизацию:
   1. Middleware `isAdmin` допускает доступ только пользователям с ролью "admin".
   2. Middleware `isOwnerOrAdmin` допускает доступ, если пользователь — владелец ресурса или администратор.

_Политика действий по ролям_:

- _Обычный пользователь_ (`role=user`):
  - Создание задач (POST `/api/todos`)
  - Просмотр задач (GET `/api/todos`)
- _Администратор_ (`role=admin`):
  - Полный доступ ко всем задачам (CRUD на `/api/todos`)
  - Управление категориями (CRUD на `/api/categories`)

### Шаг 4. (Дополнительное задание) Реализация модели авторизации RBAC

Реализуйте расширенную модель ролевой авторизации (RBAC — Role-Based Access Control), в которой роли и права доступа хранятся в отдельных таблицах базы данных.

В рамках этой модели каждая роль имеет набор разрешений (permissions), а пользователи наследуют права через назначенные роли.

Пример структуры таблиц:

- `roles` — список ролей (например, `admin`, `manager`, `user`);
- `permissions` — список доступных действий (например, `CREATE_TODO`, `DELETE_CATEGORY`);
- `role_permissions` — связывает роли с их разрешениями (связь многие-ко-многим);
- `user_roles` — связывает пользователей с ролями (также связь многие-ко-многим).

> См. лекцию 08_Auth, раздел Role-Based Access Control (RBAC) — для пояснения принципов и примеров применения.

Задача студента:

- спроектировать таблицы и связи для хранения ролей и разрешений;
- расширить middleware авторизации, чтобы проверка прав происходила не только по роли, но и по конкретному разрешению;
- продемонстрировать работу системы RBAC на примере ограничения доступа к маршрутам (например, только роль `admin` может удалять категории или видеть всех пользователей).

### Шаг 5. (Дополнительное задание) Интеграция с Passport.js (альтернативный вариант)

> Если хотите, можно реализовать аутентификацию не вручную, а через библиотеку `Passport.js` с стратегией `passport-jwt`.

1. Использовать модули: `passport`, `passport-jwt`, `bcrypt`.
2. Создать стратегию `JwtStrategy`, которая проверяет подпись токена и извлекает пользователя.
3. Подключить middleware `passport.authenticate('jwt', { session: false })` к защищённым маршрутам.

### Шаг 6. Проверка и демонстрация

1. Зарегистрируйте двух пользователей:
   1. `admin@example.com` с ролью `admin`
   2. `user@example.com` с ролью `user`
2. Войдите и получите JWT для каждого.
3. Проверьте следующие сценарии:
   1. user выполняет `POST /api/todos` — успешно.
   2. user выполняет `DELETE /api/todos/:id` — получает `403 Forbidden`
   3. admin выполняет `PUT/DELETE` на любую задачу или категорию → успех (`200/204`).

## Контрольные вопросы

1. Что такое JWT и как он работает?
2. Как реализовать безопасное хранение паролей пользователей?
3. В чём разница между аутентификацией и авторизацией?
4. Какие преимущества и недостатки использования Passport.js для аутентификации в Node.js
